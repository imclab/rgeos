checkPolygonsGEOS <- function(obj) {
    if (!is(obj, "Polygons")) 
        stop("not a Polygons object")
    res0 <- .Call("rgeos_PolygonsContain", .RGEOS_HANDLE, obj, PACKAGE="rgeos")
    lmat <- res0[[1]]
    idmat <- res0[[2]]
# handle equals deletion
    if (is.null(res0)) {
        Pls <- slot(obj, "Polygons")
        hls <- sapply(Pls, function(x) slot(x, "hole"))
        if (any(hls)) {
            for (i in 1:length(Pls)) {
                if (hls[i]) {
                    Pl <- Pls[[i]]
                    crds <- slot(Pl, "coords")
                    crds <- crds[nrow(crds):1,]
                    Pls[[i]] <- Polygon(crds, hole=FALSE)
                }
            }
            slot(obj, "Polygons") <- Pls
        }
        comment(obj) <- paste(rep(0, length(hls)), collapse=" ")
        return(obj)
    }
    if (any(idmat == 1)) {
        idents <- which(idmat == 1, arr.ind = TRUE)
        idents2 <- which(idmat %*% idmat == 1, arr.ind=TRUE)
        if (all(idents2[,1] == idents2[,2])) {
            done <- NULL
            for (i in 1:nrow(idents)) {
                j <- idents[i,1]
                if (is.na(match(j, done))) {
                    jj <- match(j, idents[,2])
                    if (!is.na(jj)) {
                        done <- c(done, c(j, idents[i,2]))
                        lmat[j, idents[i,2]] <- FALSE
                    } else 
                        warning("Odd cycles: no adjustment for equal polygons")
                }
            }
        } else warning("Odd cycles: no adjustment for equal polygons")
    }
    containsij <- which(lmat == 1, arr.ind=TRUE)
    if (sum(lmat %*% lmat) > 0) {
        areas <- sapply(slot(obj, "Polygons"), slot, "area")
        ss <- split(containsij[,1], containsij[,2])
        island <- sapply(ss, function(x) (length(x) %% 2) == 0)
        islands <- as.integer(names(island)[island])
        sss <- lapply(ss, function(x) {
            if (length(x) == 1) return(x)
            x[which.min(areas[x])]
            })
        sss <- sss[-match(islands, names(sss))]
        res <- NULL
        for (i in seq(along=sss))
           res <- rbind(res, c(sss[[i]], as.integer(names(sss)[i])))
        colnames(res) <- c("row", "col")
        containsij <- res
    }
    pls <- slot(obj, "Polygons")
    for (i in containsij[,2]) {
        pl <- pls[[i]]
        if (!slot(pl, "hole")) {
            pl <- Polygon(slot(pl, "coords"), hole=TRUE)
            pls[[i]] <- pl
        }
    }
#    slot(obj, "Polygons") <- pls
    oobj <- Polygons(pls, ID=slot(obj, "ID"))
    n <- dim(lmat)[1]
    eRiR <- as.integer(1:n %in% containsij[,2])
    eRiR[containsij[,2]] <- containsij[,1]
    ceRiR <- paste(eRiR, collapse=" ")
    comment(oobj) <- ceRiR
    return(oobj)
}

comment2comm <- function(str) {
    if (is.null(str)) return(str)
    res <- as.integer(unlist(strsplit(str, " ")))
    res <- lapply(which(res == 0), function(y) c(y, which(res == y)))
    res
}



poly_findInBoxGEOS <- function(spl, as_points=TRUE) {
    stopifnot(is(spl, "SpatialPolygons"))
    stopifnot(is.logical(as_points))
    stopifnot(!is.na(as_points))
    pls <- slot(spl, "polygons")
    .Call("rgeos_poly_findInBox", .RGEOS_HANDLE, pls, as_points,
       PACKAGE="rgeos")
}
